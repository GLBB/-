# Parallel 收集器

> 2019/9/13

Parallel 收集器以吞吐量为先，分代的垃圾收集器，和 serial 收集器是相似的，主要的区别在于Parallel 收集器会利用多线程来加速垃圾收集。

-XX:+UseParallelGC ：启用 Parallel 收集器，新生代和老年代都使用Parallel 收集器。

## Parallel 收集器线程数

在多核平台上，如果核数多余 8，那么 Parallel 会用一个小数去乘以核数，这个小数在某些平台上取值为 5/8，在有些平台上取值为 5/16。如果核数小于 8，那么垃圾收集线程等于核数。

在单核处理器上，parallel  收集器表现没有 serial 好，因为有线程同步的开销。可是在现代处理机上，一般多于两个核，在中等或大堆上，表现通常比 serial 好。

`-XX:ParallelGCThreads=`<N> ： 指定垃圾收集的线程数。

每一个垃圾收集线程在老年代都占有一个 buffer, 用来存储从年轻代提升到老年代的对象，这就有可能造成碎片问题。可以通过减少垃圾收集线程数量或者增大老年代大小解决。

## 分代安排

![](./img/6-1.png)

## Parallel 自动调整

Parallel 能够指定一些目标，而不是具体的堆的大小参数。

可以指定垃圾收集停止时间，吞吐量，footprint  

* 指定最大的垃圾收集停止时间：`-XX:MaxGCPauseMillis=`<N> ，默认没有最大的GC停止时间，如果指定了该参数，jvm 会调整堆的大小和其他参数来满足该参数设定的值，保证垃圾收集停止时间少于设置的时间。这个参数可能会降低垃圾收集总的吞吐量。

* 吞吐量：吞吐量是垃圾收集的时间与应用时间的比值。`-XX:GCTimeRatio=`<N> 设置吞吐量，1/(1+N)

  例子：`-XX:GCTimeRatio=`19， 则垃圾收集时间占 1/20, 默认值是 99, 即垃圾收集时间占 1/100

* footprint: 设置堆的最大空间使用参数: `-Xmx`<N> , 垃圾收集器默认会以最小的堆内存来满足上述目标。

## 目标的优先级

停止时间> 吞吐量 > footprint

## Parallel  收集器分代空间调整

垃圾收集器会保存平均停止时间等一些统计参数。

目标如果已经被满足了，垃圾收集器就会调整分代的大小。为了维护统计数据的准确性，会忽略显示调用 System.gc() 的影响。

分代的增长和收缩是以固定的百分比来计算的。增长和收缩他们的百分比是不同的。默认增长的百分比是 20%, 收缩的百分比是 5%。增长可以设置的参数有：年轻代: `-XX:YoungGenerationSizeIncrement=`<Y> , 老年代: `-XX:TenuredGenerationSizeIncrement=`<T> .

收缩的百分比设置: `-XX:AdaptiveSizeDecrementScaleFactor=`<D> ，如果增长百分比是 X%, 那么收缩百分比是 X/D%。

为了增加启动时的性能，分代大小增加会有一个附加的百分比。收缩时没有这个附加的百分比。

停止时间目标如果满足不了，收缩某个代的大小，如果两个代的停止时间都没有满足，那么先缩小停止时间大的那一个代。

如果吞吐量没有满足，那么会增加两个代的大小。

## Parallel  默认堆大小

默认最大堆大小为物理内存的 1/4, 初始堆大小为物理内存的 1/64。年轻代最大占堆的 1/3。

## 指定Parallel收集器初始化和最大堆大小

堆大小指定参数

* 初始化: -Xms 
* 最大: -Xmx 

 `-XX:+PrintFlagsFinal`  ：查看所有的默认值

## 过多的垃圾收集时间和 OutOfMemoryError

如果花在垃圾收集的时间过多，会抛出 OutOfMemoryError

如果垃圾收集时间占比达到 98%, OutOfMemoryError。

可以关闭该特性，使用参数: -XX:-UseGCOverheadLimit 







