# G1 垃圾收集器调优

> 2019/09/15

## G1推荐设置

推荐使用 G1 的默认设置, 只需要设置期望的停止时间和最大堆的大小就行。

G1 是其他垃圾收集器的一个综合，G1 默认配置既不会最大化吞吐量，也不会最小化延迟，而是在高吞吐量的基础上提供相对小的，一致的延迟。G1 增量搜集和停止时间控制可能会导致一些应用线程和垃圾回收线程额外的开销。

如果你倾向于高吞吐量，可以将停止时间的目标设置大一点或者提供一个大堆。如果延迟是高优先级，可以设置停止时间目标。不要去限制年轻代的大小，不要设置参数如：-Xmn， -XX:NewRatio 等，因为 G1 主要是通过设置年轻代的大小来满足停止时间的目标。

-XX:MaxGCPauseMillis ：设置垃圾收集停止时间目标

## 从其他垃圾收集器迁移到 G1

去除 jvm 的全部参数，然后只设置停止时间目标和堆的大小。因为以前设置的参数可能会给 G1 带来副作用。

## 提高性能

G1 不需要指定额外的参数，就能获得比较高的吞吐量。对于某些情况，默认的参数或者启发式优化（vm 根据统计信息自己调整）产生的结果还有优化空间。这里给出一些指导和查看诊断信息来优化这些情况。这些指导只是为提高性能提供了一定的可能性。针对某个应用而言，做应用级优化可能比 VM 级别的优化更好，例如避免大量存在长时间存活的对象。

G1 提供完全的日志信息，可以通过参数：-Xlog:gc*=debug 查看详细信息。

### 观察 Full GC

Full GC 非常消耗时间，引发原因通常是老年代空间不足，日志中标记 Full GC：**Pause Full (Allocation Failure) **。疏散失败的标识是：`to-space exhausted `，Full GC 通常先于疏散失败出现。

发生 Full Gc 的原因主要是应用分配了大量的对象而不能及时进行清理。在  space-reclamation 阶段，并发标记不能及时的完成，同时又分配了许多大对象， 这些大对象超过了 G1 的预期，就会变成 Full GC。

需要确保并发标记及时完成，可以降低老年代的分配速率，或者给并发标记更多的时间。

相关选项：

* 查看大对象区域占用的的空间，加入参数 `gc+heap=info ` 。日志信息中将会显示："`Humongous regions: X->Y`” 。如果显示的数量比老年代区域数量还多，可以降低对象数量，也可以增加 region 的大小，设置参数: -XX:G1HeapRegionSize 。
* 增加堆的大小，带来的副作用就是标记的时间也更长了。
* 增加并发标记的线程数, 设置参数: `-XX:ConcGCThreads`
* 强迫 G1 更早的开始标记。G1 自适应学习老年代达到多少百分比是进行回收，当应用程序行为发生改变时，预测可能会错误。有两个选项，第一个是设置更低比例，达到这个比例老年代就开始垃圾回收，使用参数:-XX:G1ReservePercent 。 第二个选项是关闭自适应学习，-XX:-G1UseAdaptiveIHOP ，同时设置达到多少占比时就开始回收：-XX:InitiatingHeapOccupancyPercent 。

其他引发 Full GC 要么是程序显式调用 System.gc(), 也么是外部工具触发的 full gc。

减轻 System.gc() 的影响，设置参数: -XX:+ExplicitGCInvokesConcurrent 。或者忽略显式的调用，-XX:+DisableExplicitGC。

### 大对象碎片

大对象碎片的解决办法是要么增加 region 的大小，要么增大堆的大小。

增大 region 大小: -XX:G1HeapRegionSize 

### 延迟调优

**实时使用**

参数: `gc+cpu=info ` 输出包含操作系统，vm 停止时间.

样例输出: User=0.19s Sys=0.00s Real=0.01s 

User time  是 VM， Sys 是操作系统， Real 是停止的绝对时间，如果系统时间比较高，通常是环境问题。

系统停止时间比较高的情况有:

* VM 申请或者归还内存从操作系统，避免这种延迟可以将堆最大和最小设为相等，同时设置预先占用（在VM 启动阶段就占用空间）：-XX:+AlwaysPreTouch 
* 在 Linux 上，会将小页合并为大页，这个特性称为：`Transparent Huge Pages (THP) `，随机导致进程减速，不仅仅只是在垃圾收集停止的时间，因为VM占用大量的内存，很可能会影响到 VM, 可以查看 linux 文档，关闭这个特性。
* 其他的一些后台任务间隔性的写磁盘，导致I/O带宽被沾满，可以为应用单独准备一块硬盘。





### 吞吐量调优



### 堆大小调优



### 调整参数







